<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†’éšªè€…å…¬æœƒ - ç¿’æ…£é¤Šæˆæ—¥èªŒ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Pixel Art Feel (VT323) -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* è‡ªå®šç¾© Tailwind é…ç½® */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'guild-wood': '#6F4F28', /* æœ¨ç´‹æ£• */
                        'guild-parchment': '#F5E6CC', /* ç¾Šçš®ç´™ */
                        'guild-gold': '#FFD700', /* é‡‘è‰² */
                        'guild-dark': '#38220C', /* æ·±æ£•è‰² */
                        'guild-accent': '#C0842B', /* å¤§åœ°è‰²ç³» */
                    },
                    fontFamily: {
                        pixel: ['VT323', 'monospace'],
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </style>
    <style>
        /* æ‡‰ç”¨ç¨‹å¼å…¨åŸŸé¢¨æ ¼ */
        body {
            background-color: #F5E6CC; /* ç¾Šçš®ç´™èƒŒæ™¯ */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* æ¨¡æ“¬å…¬æœƒæœ¨ç‰Œ/ç¾Šçš®ç´™é‚Šæ¡† */
        .guild-card {
            border: 4px solid #6F4F28;
            box-shadow: 8px 8px 0px rgba(56, 34, 12, 0.7); /* æ¨¡æ“¬ç«‹é«”åƒç´ é™°å½± */
            background-color: #FAF4E8;
            border-radius: 8px;
            padding: 1.5rem;
        }

        /* åƒç´ é¢¨æ ¼æŒ‰éˆ• */
        .guild-btn {
            background-color: #C0842B; /* å¤§åœ°è‰²ç³» */
            color: white;
            padding: 8px 16px;
            border: 3px solid #6F4F28;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            transition: all 0.1s;
            box-shadow: 2px 2px 0px #38220C;
        }
        .guild-btn:hover {
            background-color: #D99D46;
            box-shadow: 4px 4px 0px #38220C;
        }
        .guild-btn:active {
            box-shadow: 0px 0px 0px #38220C;
            transform: translate(2px, 2px);
        }

        /* åƒç´ æ¨™é¡Œå­—é«” - åŸºç¤å­—é«” (æ‰€æœ‰ä»‹é¢å…±ç”¨ï¼Œç„¡é™°å½±) */
        .pixel-font {
            font-family: 'VT323', monospace;
            letter-spacing: 0.1em;
        }

        /* ä»»å‹™å®Œæˆå‹¾é¸æ¡† */
        input[type="checkbox"]:checked + label .check-icon {
            opacity: 1;
            transform: scale(1);
        }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ç§»é™¤ GoogleAuthProvider å’Œ signInWithPopup
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, addDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase log level
        setLogLevel('Debug');

        // --- å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Firebase config parsing error:", e);
            firebaseConfig = {};
        }

        let app;
        let db;
        let auth;
        let userId = null;
        let isTeacher = false;
        let studentProfile = null;
        let studentList = [];
        let classConfig = null;
        let currentView = 'loading'; // loading, login, teacherSetup, studentSetup, dashboard, teacherDashboard

        // ç²å– URL åƒæ•¸çš„è¼”åŠ©å‡½æ•¸
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // ç™»å…¥ç‹€æ…‹ç›£è½
        window.addEventListener('load', () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener();
            } else {
                updateView('error', 'ç„¡æ³•è¼‰å…¥ Firebase è¨­å®šï¼Œè«‹æª¢æŸ¥ç’°å¢ƒã€‚');
            }
        });

        async function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await checkUserRole(user.uid);
                } else {
                    userId = null;
                    isTeacher = false;
                    studentProfile = null;
                    updateView('login');
                }
            });

            // è™•ç†åˆå§‹èªè­‰ Token
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("Initial sign-in with custom token failed:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Anonymous sign-in failed:", e);
                    }
                }
            } else {
                // If no token, sign in anonymously
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Anonymous sign-in failed:", e);
                }
            }
        }

        async function checkUserRole(uid) {
            const enrollmentId = getUrlParameter('enrollId');

            // 1. æª¢æŸ¥æ˜¯å¦æœ‰è¨»å†Šé€£çµ (å­¸ç”Ÿçš„å°ˆå±¬é€£çµ)
            if (enrollmentId) {
                await claimStudentProfile(enrollmentId, uid);
                return;
            }

            // 2. æª¢æŸ¥ç­ç´šè¨­å®šï¼ˆæ•™å¸«æ˜¯å¦å·²è¨­å®šï¼‰
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'classData', 'config');
            const configSnap = await getDoc(configRef);

            if (!configSnap.exists()) {
                // å°šæœªæœ‰ç­ç´šè¨­å®šï¼Œå°‡ç•¶å‰ç”¨æˆ¶é–å®šç‚ºè€å¸«
                updateView('teacherSetup');
                return;
            }

            classConfig = configSnap.data();

            if (classConfig.teacherId === uid) {
                isTeacher = true;
                updateView('teacherDashboard');
                return;
            }

            // 3. æª¢æŸ¥æ˜¯å¦ç‚ºå·²è¨»å†Šå­¸ç”Ÿ (å­¸ç”Ÿæ‡‰è©²æ˜¯ä½¿ç”¨ç•¶å‰ UID)
            const studentRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', uid);
            const studentSnap = await getDoc(studentRef);

            if (studentSnap.exists() && studentSnap.data().isRegistered === true) {
                studentProfile = studentSnap.data();
                isTeacher = false;
                setupStudentDataListeners(uid);
                updateView('dashboard');
                return;
            }

            // 4. æ—¢éè€å¸«ä¹Ÿéå·²è¨»å†Šå­¸ç”Ÿ
            isTeacher = false;
            updateView('login');
        }

        // --- é€šç”¨è¼”åŠ©å‡½æ•¸ ---

        function showMessage(message, isError = false) {
            const el = document.getElementById('status-message');
            if (el) {
                el.textContent = message;
                el.className = `p-3 rounded-md mt-4 text-sm font-bold ${isError ? 'bg-red-200 text-red-800 border-red-800' : 'bg-green-200 text-green-800 border-green-800'} border-2`;
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 5000);
            }
        }

        function updateView(newView, message = null) {
            currentView = newView;
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            // æ¸…ç©ºä¸¦è¨­å®šæ–°çš„å…§å®¹
            appContainer.innerHTML = '';
            appContainer.className = 'w-full max-w-4xl mx-auto p-4 md:p-8'; // Reset class

            switch (newView) {
                case 'loading':
                    // ç§»é™¤ pixel-shadow é¡åˆ¥
                    appContainer.innerHTML = `<div class="text-center p-8 guild-card"><h2 class="pixel-font text-3xl text-guild-dark">å…¬æœƒæº–å‚™ä¸­...</h2><p class="mt-4">æ­£åœ¨é©—è­‰æ‚¨çš„å†’éšªè€…èº«ä»½...</p></div>`;
                    break;
                case 'login':
                    renderLoginView();
                    break;
                case 'teacherSetup':
                    renderTeacherSetupView();
                    break;
                case 'studentSetup':
                    // å­¸ç”Ÿè¨»å†Šé ˜å–åç¨±æµç¨‹ï¼ˆé€šéå°ˆå±¬ ID é€²å…¥ï¼‰
                    // è¨»å†Šé‚è¼¯å·²ç§»åˆ° claimStudentProfileï¼Œé€™è£¡åªé¡¯ç¤ºéŒ¯èª¤
                    appContainer.innerHTML = `<div class="text-center p-8 guild-card bg-red-100"><h2 class="pixel-font text-4xl text-red-700">è¨ªå•å—é™!</h2><p class="mt-4 text-lg">æ‚¨å¿…é ˆä½¿ç”¨è€å¸«æä¾›çš„å°ˆå±¬è¨»å†Šé€£çµé€²å…¥æ­¤é é¢ã€‚</p></div>`;
                    break;
                case 'dashboard':
                    renderStudentDashboard();
                    break;
                case 'teacherDashboard':
                    renderTeacherDashboard();
                    break;
                case 'error':
                    // ç§»é™¤ pixel-shadow é¡åˆ¥
                    appContainer.innerHTML = `<div class="text-center p-8 guild-card bg-red-100"><h2 class="pixel-font text-4xl text-red-700">ä»»å‹™å¤±æ•—!</h2><p class="mt-4 text-lg">${message}</p><p>è«‹å˜—è©¦é‡æ–°æ•´ç†æˆ–è¯ç¹«è€å¸«ã€‚</p></div>`;
                    break;
            }
            if (message) showMessage(message);
        }

        // --- éŠæˆ²é‚è¼¯èˆ‡è³‡æ–™çµæ§‹ ---

        const LEVEL_CONFIG = [
            { name: "åˆå¿ƒè€… (Novice)", range: [1, 5], xpPerLevel: 50 },
            { name: "å°è©¦èº«æ‰‹ (Dabbler)", range: [6, 10], xpPerLevel: 75 },
            { name: "ç†Ÿç·´è€… (Adept)", range: [11, 15], xpPerLevel: 100 },
            { name: "æ¦®è­½å†’éšªè€… (Honored Adventurer)", range: [16, 20], xpPerLevel: 150 },
        ];
        
        function getLevelInfo(totalXp) {
            let currentXp = totalXp;
            let currentLevel = 1;
            let xpToNextLevel = 50; // Default for Lvl 1

            for (const tier of LEVEL_CONFIG) {
                for (let i = tier.range[0]; i <= tier.range[1]; i++) {
                    const levelRequiredXp = (i === 1) ? 0 : tier.xpPerLevel;
                    
                    if (currentXp < levelRequiredXp) {
                        xpToNextLevel = levelRequiredXp - currentXp;
                        return { level: currentLevel, tier: tier.name, xp: currentXp, xpToNextLevel };
                    }
                    
                    currentXp -= levelRequiredXp;
                    currentLevel = i + 1;
                    xpToNextLevel = tier.xpPerLevel;

                    if (i === 20) { // Max level reached
                         return { level: 20, tier: "å‚³å¥‡å…¬æœƒè‹±é›„ (Legendary Hero)", xp: totalXp, xpToNextLevel: 0 };
                    }
                }
            }
            return { level: 1, tier: "åˆå¿ƒè€… (Novice)", xp: totalXp, xpToNextLevel: 50 }; // Should only hit if Lvl 1
        }
        
        // --- èªè­‰èˆ‡åˆå§‹åŒ–ä»‹é¢ ---

        function renderLoginView() {
            document.getElementById('app-container').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[80vh]">
                    <div class="guild-card w-full max-w-sm text-center">
                        <h1 class="pixel-font text-4xl text-guild-accent mb-4">å†’éšªè€…å…¬æœƒ</h1>
                        <p class="mb-6 text-guild-dark">æ­¡è¿ï¼è«‹è¯ç¹«å¤§é•·è€ç²å–æ‚¨çš„å°ˆå±¬å†’éšªè€…é€£çµã€‚</p>
                        <p class="mb-6 text-sm text-gray-500">æ­¤ç³»çµ±å·²é…ç½®ç‚ºä½¿ç”¨è€å¸«æä¾›çš„å°ˆå±¬é€£çµé€²è¡Œä¸€æ¬¡æ€§èº«ä»½ç¶å®šã€‚</p>
                    </div>
                </div>
            `;
            // ç§»é™¤ Google ç™»å…¥æŒ‰éˆ•
        }

        // --- å­¸ç”Ÿé ˜å–æª”æ¡ˆ (Claim) é‚è¼¯ ---
        async function claimStudentProfile(enrollmentId, currentUserId) {
            // 1. æª¢æŸ¥ç›®æ¨™é ˜å– ID æ˜¯å¦å­˜åœ¨ä¸”æœªè¨»å†Š
            const oldRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', enrollmentId);
            const oldSnap = await getDoc(oldRef);

            if (!oldSnap.exists()) {
                updateView('error', 'è©²å°ˆå±¬é€£çµç„¡æ•ˆï¼Œè«‹æª¢æŸ¥é€£çµæ˜¯å¦æ­£ç¢ºã€‚');
                return;
            }

            const oldProfile = oldSnap.data();

            if (oldProfile.isRegistered === true) {
                // å¦‚æœæ˜¯å·²è¨»å†Šï¼Œå¯èƒ½æ˜¯ç”¨æˆ¶å˜—è©¦ç”¨é€£çµé‡æ–°ç™»å…¥ï¼Œæ‡‰è©²å°å‘å„€è¡¨æ¿
                if (oldProfile.uid === currentUserId) {
                    showMessage(`æ‚¨å·²ç¶“æ˜¯ ${oldProfile.name} å†’éšªè€…ï¼Œè‡ªå‹•å°å‘å„€è¡¨æ¿ã€‚`);
                    studentProfile = oldProfile;
                    setupStudentDataListeners(currentUserId);
                    updateView('dashboard');
                    return;
                } else {
                    updateView('error', `è©²é€£çµå·²è¢« ${oldProfile.name} å†’éšªè€…é ˜å–ã€‚`);
                    return;
                }
            }


            // 2. æª¢æŸ¥ç•¶å‰ç”¨æˆ¶ UID æ˜¯å¦å·²è¨»å†Šé
            const currentProfileRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', currentUserId);
            const currentProfileSnap = await getDoc(currentProfileRef);

            if (currentProfileSnap.exists() && currentProfileSnap.data().isRegistered === true) {
                 updateView('error', `æ‚¨çš„èº«ä»½ (${currentUserId}) å·²ç¶å®šç‚º ${currentProfileSnap.data().name} å†’éšªè€…ï¼Œä¸èƒ½é‡è¤‡è¨»å†Šï¼`);
                 return;
            }

            // 3. åŸ·è¡Œé ˜å–/è½‰ç§»
            try {
                // (A) å»ºç«‹æ–°çš„å­¸ç”Ÿæª”æ¡ˆï¼ˆä½¿ç”¨ç•¶å‰ç”¨æˆ¶çš„ UID ä½œç‚ºæ–‡ä»¶ IDï¼‰
                const newProfile = {
                    // æ‹·è²èˆŠè³‡æ–™ï¼Œä½†ä½¿ç”¨ç•¶å‰ç”¨æˆ¶ UID ä½œç‚ºæ–°çš„æ–‡ä»¶ ID
                    teacherId: oldProfile.teacherId,
                    name: oldProfile.name, // é–å®šåç¨±
                    totalXp: oldProfile.totalXp || 0,
                    goals: oldProfile.goals || [],
                    achievements: oldProfile.achievements || [],
                    // ä»¥ä¸‹æ˜¯æ–°æ•¸æ“š
                    uid: currentUserId, 
                    isRegistered: true, // æ¨™è¨˜ç‚ºå·²è¨»å†Š
                    lastLogin: new Date().toISOString(),
                    // ç§»é™¤èˆŠçš„å”¯ä¸€é€£çµID
                    studentNo: undefined
                };
                
                await setDoc(currentProfileRef, newProfile);
                
                // (B) åˆªé™¤èˆŠçš„è¨»å†Šé ç•™æ–‡ä»¶ (ä½¿ç”¨ enrollmentId ä½œç‚ºæ–‡ä»¶ ID)
                await deleteDoc(oldRef);

                showMessage(`âœ… æˆåŠŸé ˜å–ï¼æ­¡è¿ ${oldProfile.name} å†’éšªè€…ï¼æª”æ¡ˆå·²ç¶å®šåˆ°æ‚¨çš„ç€è¦½æœƒè©±ã€‚`);
                studentProfile = newProfile;
                setupStudentDataListeners(currentUserId);
                // æˆåŠŸè¨»å†Šå¾Œï¼Œæ¸…é™¤ URL åƒæ•¸ï¼Œé¿å…å†æ¬¡è§¸ç™¼é ˜å–æµç¨‹
                window.history.replaceState(null, null, window.location.pathname);
                updateView('dashboard');
                
            } catch (error) {
                console.error("é ˜å–æª”æ¡ˆå¤±æ•—:", error);
                showMessage("æª”æ¡ˆé ˜å–å¤±æ•—: " + error.message, true);
            }
        }


        // --- å¤§é•·è€æ¬Šé™å•Ÿç”¨ (æ•™å¸«) ---

        function renderTeacherSetupView() {
            const container = document.getElementById('app-container');
            if (!container || !auth.currentUser) return;

            const contentHTML = `
                <h1 class="pixel-font text-4xl text-red-700 mb-4">ğŸš¨ å¤§é•·è€æ¬Šé™å•Ÿç”¨ ğŸš¨</h1>
                <p class="mb-6 text-lg">é€™æ˜¯æœ¬å…¬æœƒé¦–æ¬¡å•Ÿç”¨ã€‚æ‚¨å°‡æˆç‚ºé€™å±†å­¸ç”Ÿçš„ã€Œå¤§é•·è€ã€ï¼ˆæ•™å¸«ï¼‰ã€‚</p>
                <p class="mb-6 text-sm text-gray-600">æ‚¨çš„ç•¶å‰æœƒè©±èº«ä»½ (UID: ${userId}) å°‡è¢«é–å®šç‚ºæ•™å¸«èº«ä»½ï¼Œä¸€æ—¦è¨­å®šï¼Œä¸å¯æ›´æ”¹ã€‚</p>
                <button id="activate-teacher-btn" class="guild-btn bg-red-700 hover:bg-red-800 w-full">
                    ç¢ºèªä¸¦å•Ÿç”¨å¤§é•·è€æ¬Šé™
                </button>
            `;
            container.innerHTML = `<div class="flex flex-col items-center justify-center min-h-[80vh]"><div class="guild-card w-full max-w-lg text-center">${contentHTML}</div></div>`;
            // å°‡å•Ÿç”¨æŒ‰éˆ•ç¶å®šåˆ°å¯¦éš›çš„å•Ÿç”¨è§’è‰²å‡½æ•¸
            document.getElementById('activate-teacher-btn').onclick = activateTeacherRole;
        }

        async function activateTeacherRole() {
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'classData', 'config');
            try {
                await setDoc(configRef, {
                    teacherId: userId,
                    teacherEmail: auth.currentUser.email || 'N/A (Custom Auth)', // ç§»é™¤ Google ç›¸é—œ email
                    createdAt: new Date().toISOString(),
                    currentYear: new Date().getFullYear(),
                    levels: LEVEL_CONFIG,
                });
                showMessage("å¤§é•·è€æ¬Šé™å•Ÿç”¨æˆåŠŸï¼æ­¡è¿ä¾†åˆ°å…¬æœƒï¼");
                isTeacher = true;
                updateView('teacherDashboard');
            } catch (error) {
                console.error("å•Ÿç”¨å¤§é•·è€æ¬Šé™å¤±æ•—:", error);
                showMessage("å•Ÿç”¨å¤±æ•—: " + error.message, true);
            }
        }

        // --- å­¸ç”Ÿæª”æ¡ˆå‰µå»º (å·²ç§»é™¤ï¼Œæ”¹ç‚º claimStudentProfile) ---

        async function getStudentList() {
            if (!classConfig) return [];
            const studentsCol = collection(db, 'artifacts', appId, 'public', 'data', 'students');
            const q = query(studentsCol, where("teacherId", "==", classConfig.teacherId));
            const snapshot = await getDocs(q);
            studentList = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            return studentList;
        }

        // --- å­¸ç”Ÿå„€è¡¨æ¿ ---

        function setupStudentDataListeners(uid) {
            // ç›£è½å­¸ç”Ÿå€‹äººè³‡æ–™ (XP, Level, Goals)
            const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', uid);
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    studentProfile = docSnap.data();
                    if (currentView === 'dashboard') renderStudentDashboard();
                } else {
                    console.error("Student profile not found!");
                    updateView('login', 'æ‚¨çš„å†’éšªè€…æª”æ¡ˆä¼¼ä¹éºå¤±äº†ï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
                }
            });

            // ç›£è½æ¯æ—¥ä»»å‹™ (å‡è¨­æ¯æ—¥ä»»å‹™ä»¥æ—¥æœŸç‚º doc ID å„²å­˜)
        }

        function renderStudentDashboard() {
            if (!studentProfile) return;

            const levelInfo = getLevelInfo(studentProfile.totalXp);
            const maxXp = levelInfo.xp + levelInfo.xpToNextLevel;
            const xpProgress = maxXp > 0 ? (levelInfo.xp / maxXp) * 100 : 0;
            const currentLevelName = `${levelInfo.level} ç´š - ${levelInfo.tier}`;

            document.getElementById('app-container').innerHTML = `
                <div class="space-y-8">
                    <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
                    <div class="guild-card flex justify-between items-center bg-guild-dark text-guild-parchment p-6">
                        <div class="flex-1">
                            <p class="text-xl">ğŸŒŸ å†’éšªè€…: <span class="pixel-font text-guild-gold">${studentProfile.name}</span></p>
                            <p class="text-sm text-gray-400">UID: ${userId}</p>
                        </div>
                        <div class="text-right">
                            <p class="pixel-font text-3xl">ç­‰ç´š: ${levelInfo.level}</p>
                            <p class="text-sm">${currentLevelName}</p>
                            <div class="mt-2 w-48 bg-gray-600 rounded-full h-2.5">
                                <div class="bg-guild-gold h-2.5 rounded-full" style="width: ${xpProgress}%"></div>
                            </div>
                            <p class="text-xs mt-1">${levelInfo.xp} / ${maxXp} XP (è·ä¸‹ä¸€ç´š)</p>
                        </div>
                        <button class="guild-btn ml-4 bg-red-600 hover:bg-red-700" onclick="handleLogout()">ç™»å‡º</button>
                    </div>

                    <!-- ä»»å‹™æ—¥èªŒ / æœˆæ›† -->
                    <div class="guild-card">
                        <h2 class="pixel-font text-3xl text-guild-accent border-b-2 border-guild-wood pb-2 mb-4">å†’éšªè€…æ—¥èªŒ (æœˆæ›†)</h2>
                        <!-- ç°¡åŒ–æœˆæ›†ï¼Œåªé¡¯ç¤ºç•¶å‰æ—¥æœŸ -->
                        ${renderCalendar()}
                    </div>

                    <!-- ä»Šæ—¥ä»»å‹™ -->
                    <div id="daily-tasks-section" class="guild-card">
                        <h2 class="pixel-font text-3xl text-guild-accent border-b-2 border-guild-wood pb-2 mb-4">ğŸ“œ ä»Šæ—¥ä»»å‹™ (${new Date().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' })})</h2>
                        <div id="tasks-list">æ­£åœ¨è®€å–ä»Šæ—¥ä»»å‹™...</div>
                    </div>

                    <!-- æ”¶ä¿¡åŠŸèƒ½ / æˆå°± -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="guild-card">
                            <h2 class="pixel-font text-3xl text-guild-accent border-b-2 border-guild-wood pb-2 mb-4">âœ‰ï¸ ä¾†è‡ªå¤§é•·è€çš„ä¿¡ä»¶</h2>
                            <div id="student-inbox">æ­£åœ¨è®€å–ä¿¡ä»¶...</div>
                        </div>
                        <div class="guild-card">
                            <h2 class="pixel-font text-3xl text-guild-accent border-b-2 border-guild-wood pb-2 mb-4">ğŸ† éš¨æ©Ÿæˆå°±</h2>
                            <ul class="list-disc list-inside text-guild-dark space-y-2">
                                ${renderAchievements(studentProfile.achievements).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            // è®€å–ä¸¦æ¸²æŸ“ä»Šæ—¥ä»»å‹™
            fetchAndRenderDailyTasks(new Date());
            fetchAndRenderInbox();
        }

        // ç°¡åŒ–æ—¥æ›†æ¸²æŸ“ (åƒ…ç”¨æ–¼é»é¸æ—¥æœŸ)
        function renderCalendar() {
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            return `
                <div class="grid grid-cols-7 gap-1 text-center font-bold text-sm bg-guild-accent/50 p-2 rounded">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div class="grid grid-cols-7 gap-2 mt-2">
                    <div class="col-start-4"></div> <!-- å‡è¨­ä»Šå¤©æ˜¯é€±ä¸‰ -->
                    <button class="guild-card p-3 text-guild-dark bg-guild-gold/70 hover:bg-guild-gold" onclick="fetchAndRenderDailyTasks(new Date('${dateStr}'))">
                        ${today.getDate()}<br><span class="text-xs font-normal">ä»Šæ—¥</span>
                    </button>
                    <!-- å…¶ä»–æ—¥æœŸç•¥... é»æ“Šå¯æŸ¥çœ‹è©²æ—¥è¨˜éŒ„ -->
                </div>
            `;
        }

        async function fetchAndRenderDailyTasks(date) {
            const dateKey = date.toISOString().split('T')[0];
            const tasksRef = doc(db, 'artifacts', appId, 'public', 'data', 'dailyTasks', dateKey);
            const logRef = doc(db, 'artifacts', appId, 'users', userId, 'logs', dateKey);

            let tasks = { daily: [], hidden: null, special: [] };
            let log = { completed: [], teacherBonus: 0, totalScore: 0 };

            try {
                const tasksSnap = await getDoc(tasksRef);
                if (tasksSnap.exists()) tasks = tasksSnap.data();

                const logSnap = await getDoc(logRef);
                if (logSnap.exists()) log = logSnap.data();
            } catch (error) {
                console.error("Failed to fetch daily tasks or log:", error);
            }

            const isToday = dateKey === new Date().toISOString().split('T')[0];
            let listHTML = '';

            // æ¸²æŸ“æ¯æ—¥ä»»å‹™ (2é …ï¼Œå„1åˆ†)
            listHTML += `<div class="mb-6">
                <h3 class="font-bold text-xl text-guild-dark mb-2">æ¯æ—¥ä»»å‹™ (Daily Quest) - æ¯é … 1 ç©åˆ†</h3>
                <ul class="space-y-2">`;
            tasks.daily.forEach((task, index) => {
                const taskId = `daily_${index}`;
                const isCompleted = log.completed.includes(taskId);
                listHTML += `
                    <li class="p-3 border-2 rounded ${isCompleted ? 'bg-green-100 border-green-400' : 'bg-guild-parchment border-gray-300'} flex justify-between items-center">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="${taskId}" class="hidden" ${isCompleted ? 'checked' : ''} ${isToday ? '' : 'disabled'} onchange="toggleTaskCompletion('${dateKey}', '${taskId}', '${task.name}')">
                            <span class="w-6 h-6 border-2 rounded flex items-center justify-center bg-white">
                                <svg class="check-icon w-4 h-4 text-green-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </span>
                            <span class="text-lg text-guild-dark">${task.name}</span>
                        </label>
                        <span class="text-sm font-bold text-green-600">âœ… +1 ç©åˆ†</span>
                    </li>`;
            });
            listHTML += `</ul></div>`;

            // æ¸²æŸ“éš±è—ä»»å‹™ (1é …ï¼Œ2åˆ†)
            if (tasks.hidden) {
                const taskId = `hidden_0`;
                const isCompleted = log.completed.includes(taskId);
                listHTML += `<div class="mb-6">
                    <h3 class="font-bold text-xl text-guild-dark mb-2">ğŸ—ï¸ éš±è—ä»»å‹™ (Hidden Quest) - 2 ç©åˆ†</h3>
                    <div class="p-3 border-2 rounded ${isCompleted ? 'bg-yellow-100 border-yellow-500' : 'bg-guild-parchment border-gray-300'} flex justify-between items-center">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="${taskId}" class="hidden" ${isCompleted ? 'checked' : ''} ${isToday ? '' : 'disabled'} onchange="toggleTaskCompletion('${dateKey}', '${taskId}', '${tasks.hidden.name}')">
                            <span class="w-6 h-6 border-2 rounded flex items-center justify-center bg-white">
                                <svg class="check-icon w-4 h-4 text-yellow-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </span>
                            <span class="text-lg text-guild-dark">${tasks.hidden.name}</span>
                        </label>
                        <span class="text-sm font-bold text-yellow-600">âœ¨ +2 ç©åˆ†</span>
                    </div>
                </div>`;
            }

            // æ¸²æŸ“å–®æ—¥é¡å¤–çå‹µ (å®Œæˆæ‰€æœ‰ä»»å‹™ +1 åˆ†, æ•™å¸«åŠ åˆ†)
            const allTasksCompleted = tasks.daily.length + (tasks.hidden ? 1 : 0) === log.completed.length;
            const bonusText = allTasksCompleted ? '<span class="text-green-600 font-bold">+1 é¡å¤–çå‹µç©åˆ†</span>' : '<span class="text-gray-500">(æœªé”æˆ)</span>';

            listHTML += `<div class="p-4 bg-blue-50 border-2 border-blue-200 rounded">
                <p class="font-bold text-lg text-blue-800">ğŸ¯ å–®æ—¥ç¸½çµ:</p>
                <p class="mt-1">âœ… ä»»å‹™å…¨æ•¸é”æˆé¡å¤–ç©åˆ†: ${bonusText}</p>
                <p>ğŸ‘¨â€ğŸ« å¤§é•·è€é¡å¤–åŠ åˆ†: <span class="text-red-600 font-bold">+${log.teacherBonus || 0} ç©åˆ†</span></p>
                <p class="mt-2 text-xl font-extrabold text-blue-900">âœ¨ ç•¶æ—¥ç¸½ç©åˆ†: ${log.totalScore || 0} åˆ†</p>
            </div>`;


            document.getElementById('tasks-list').innerHTML = listHTML;
        }

        async function toggleTaskCompletion(dateKey, taskId, taskName) {
            if (!userId) return showMessage("è«‹å…ˆç™»å…¥ã€‚", true);

            const logRef = doc(db, 'artifacts', appId, 'users', userId, 'logs', dateKey);
            const isCompleted = document.getElementById(taskId).checked;

            try {
                let xpChange = 0;
                let taskType = taskId.startsWith('daily') ? 'æ¯æ—¥ä»»å‹™' : 'éš±è—ä»»å‹™';
                const baseXP = taskType === 'æ¯æ—¥ä»»å‹™' ? 1 : 2;

                // è®€å–ç•¶å‰æ—¥èªŒå’Œä»»å‹™è¨­å®šä¾†è¨ˆç®—åˆ†æ•¸è®ŠåŒ–
                const logSnap = await getDoc(logRef);
                const currentLog = logSnap.exists() ? logSnap.data() : { completed: [], teacherBonus: 0, totalScore: 0 };
                const tasksRef = doc(db, 'artifacts', appId, 'public', 'data', 'dailyTasks', dateKey);
                const tasksSnap = await getDoc(tasksRef);
                const tasks = tasksSnap.exists() ? tasksSnap.data() : { daily: [], hidden: null, special: [] };

                let newCompleted = [...currentLog.completed];
                let oldTotalScore = currentLog.totalScore || 0;

                if (isCompleted) {
                    if (!newCompleted.includes(taskId)) {
                        newCompleted.push(taskId);
                        xpChange = baseXP;
                    }
                } else {
                    if (newCompleted.includes(taskId)) {
                        newCompleted = newCompleted.filter(id => id !== taskId);
                        xpChange = -baseXP;
                    }
                }

                // é‡æ–°è¨ˆç®—æ¯æ—¥æ»¿åˆ†çå‹µ (1åˆ†)
                const allTasks = tasks.daily.length + (tasks.hidden ? 1 : 0);
                const allTasksCompletedBefore = currentLog.completed.length === allTasks;
                const allTasksCompletedAfter = newCompleted.length === allTasks;

                // èª¿æ•´æ»¿åˆ†çå‹µçš„ XP è®ŠåŒ–
                if (!allTasksCompletedBefore && allTasksCompletedAfter) {
                    xpChange += 1; // ç²å¾—æ»¿åˆ†çå‹µ
                } else if (allTasksCompletedBefore && !allTasksCompletedAfter) {
                    xpChange -= 1; // å¤±å»æ»¿åˆ†çå‹µ
                }

                const newTotalScore = oldTotalScore + xpChange;
                const newTotalXp = studentProfile.totalXp + xpChange;

                // 1. æ›´æ–°æ—¥èªŒ
                await setDoc(logRef, {
                    completed: newCompleted,
                    totalScore: newTotalScore,
                    teacherBonus: currentLog.teacherBonus || 0,
                    lastUpdate: new Date().toISOString()
                }, { merge: true });

                // 2. æ›´æ–°å­¸ç”Ÿç¸½ XP
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', userId), {
                    totalXp: newTotalXp
                });

                showMessage(`${taskType}ã€Œ${taskName}ã€ç‹€æ…‹å·²æ›´æ–°! ç²å¾—/å¤±å» ${xpChange} ç©åˆ†.`);

            } catch (error) {
                console.error("æ›´æ–°ä»»å‹™ç‹€æ…‹å¤±æ•—:", error);
                showMessage("ä»»å‹™æ›´æ–°å¤±æ•—: " + error.message, true);
                // Revert checkbox state on error
                document.getElementById(taskId).checked = !isCompleted;
            }
        }


        // éš¨æ©Ÿæˆå°±æ¸²æŸ“ (éœæ…‹è¨­è¨ˆ)
        function renderAchievements(completedAchievements = []) {
            const allAchievements = [
                { id: 'first_blood', name: 'é¦–æˆ°å‘Šæ·', description: 'å®Œæˆä½ çš„ç¬¬ä¸€å€‹æ¯æ—¥ä»»å‹™ã€‚' },
                { id: 'seven_days_streak', name: 'ä¸ƒæ—¥ä¹‹ç«', description: 'é€£çºŒä¸ƒå¤©å®Œæˆæ‰€æœ‰æ¯æ—¥ä»»å‹™ã€‚' },
                { id: 'fifty_club', name: 'äº”åç©åˆ†ä¿±æ¨‚éƒ¨', description: 'ç´¯ç©ç²å¾— 50 é»ç©åˆ†ã€‚' },
                { id: 'hidden_master', name: 'éš±è—ä»»å‹™å¤§å¸«', description: 'é€£çºŒäº”æ¬¡å®Œæˆéš±è—ä»»å‹™ã€‚' },
            ];

            return allAchievements.map(ach => `
                <li class="${completedAchievements.includes(ach.id) ? 'text-green-700 font-bold' : 'text-gray-500 line-through'}">
                    ${completedAchievements.includes(ach.id) ? 'ğŸ…' : 'â“'} ${ach.name} - <span class="font-normal">${ach.description}</span>
                </li>
            `);
        }

        async function fetchAndRenderInbox() {
            const inboxRef = collection(db, 'artifacts', appId, 'users', userId, 'messages');
            const q = query(inboxRef);
            const inboxEl = document.getElementById('student-inbox');
            if (!inboxEl) return;

            onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
                if (messages.length === 0) {
                    inboxEl.innerHTML = '<p class="text-gray-500">ä¿¡ç®±ç©ºç©ºå¦‚ä¹Ÿï¼Œè«‹åŠªåŠ›è®“å¤§é•·è€æ³¨æ„åˆ°ä½ å§ï¼</p>';
                    return;
                }
                
                inboxEl.innerHTML = messages.map(msg => `
                    <div class="border-b border-guild-wood/50 pb-2 mb-2">
                        <p class="font-bold text-guild-dark">${msg.title || 'ä¾†è‡ªå¤§é•·è€çš„é¼“å‹µ'}</p>
                        <p class="text-sm italic text-gray-700">${msg.content}</p>
                        <p class="text-xs text-gray-500 mt-1">ç™¼é€æ–¼: ${new Date(msg.sentAt).toLocaleDateString('zh-TW')} ${new Date(msg.sentAt).toLocaleTimeString('zh-TW')}</p>
                    </div>
                `).join('');
            });
        }


        // --- æ•™å¸«å„€è¡¨æ¿ ---

        let teacherDashboardState = {
            view: 'roster', // roster, goals, tasks, special, messages, graduation
            selectedStudentId: null
        };

        function renderTeacherDashboard() {
            document.getElementById('app-container').innerHTML = `
                <div class="space-y-6">
                    <div class="guild-card bg-guild-dark text-guild-parchment p-4 flex justify-between items-center">
                        <h1 class="pixel-font text-3xl text-guild-gold">å¤§é•·è€æ§åˆ¶ä¸­å¿ƒ</h1>
                        <div>
                            <span class="text-sm">æ•™å¸«å¸³è™Ÿ: ${auth.currentUser.uid || 'æœªç¶å®š'}</span>
                            <button class="guild-btn ml-4 bg-red-600 hover:bg-red-700 text-white" onclick="handleLogout()">ç™»å‡º</button>
                        </div>
                    </div>

                    <div class="flex flex-wrap md:flex-nowrap gap-4">
                        <!-- å°è¦½åˆ— -->
                        <div class="w-full md:w-56 flex md:flex-col flex-row overflow-x-auto space-x-2 md:space-x-0 md:space-y-2 pb-2 md:pb-0">
                            ${renderTeacherNavButton('roster', 'å…¬æœƒåå†Š (å­¸ç”Ÿç®¡ç†)')}
                            ${renderTeacherNavButton('goals', 'ç¿’æ…£ç›®æ¨™æ± ç®¡ç†')}
                            ${renderTeacherNavButton('tasks', 'æ¯æ—¥ä»»å‹™åˆ†æ´¾/ç©åˆ†')}
                            ${renderTeacherNavButton('special', 'ç‰¹åˆ¥ä»»å‹™ç™¼å¸ƒ')}
                            ${renderTeacherNavButton('messages', 'å€‹åˆ¥å¯«ä¿¡çµ¦å­¸ç”Ÿ')}
                            ${renderTeacherNavButton('graduation', 'ğŸ“ ç•¢æ¥­ (æ¸…é™¤è³‡æ–™)')}
                        </div>
                        
                        <!-- å…§å®¹å€ -->
                        <div id="teacher-content" class="guild-card flex-1 w-full min-h-[600px]">
                            <!-- Content will be rendered here based on teacherDashboardState.view -->
                            æ­£åœ¨è¼‰å…¥å…§å®¹...
                        </div>
                    </div>
                </div>
            `;
            // å•Ÿå‹•æ‰€æœ‰å¿…è¦çš„ç›£è½
            setupTeacherDataListeners();
            // åˆå§‹æ¸²æŸ“å…§å®¹
            renderTeacherContent();
        }

        function renderTeacherNavButton(viewName, label) {
            const activeClass = teacherDashboardState.view === viewName ? 'bg-guild-gold text-guild-dark' : 'bg-guild-accent hover:bg-guild-gold';
            return `<button class="guild-btn ${activeClass} whitespace-nowrap" onclick="setTeacherView('${viewName}')">${label}</button>`;
        }

        window.setTeacherView = (viewName) => {
            teacherDashboardState.view = viewName;
            renderTeacherContent();
        };

        async function setupTeacherDataListeners() {
            // ç›£è½å­¸ç”Ÿåå†Š
            const studentsCol = collection(db, 'artifacts', appId, 'public', 'data', 'students');
            const q = query(studentsCol, where("teacherId", "==", userId));

            onSnapshot(q, (snapshot) => {
                studentList = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                // å­¸ç”Ÿåå–®æ›´æ–°å¾Œï¼Œé‡æ–°æ¸²æŸ“ç›¸é—œä»‹é¢
                if (currentView === 'teacherDashboard') renderTeacherContent();
            });
        }

        async function renderTeacherContent() {
            const contentEl = document.getElementById('teacher-content');
            if (!contentEl) return;

            contentEl.innerHTML = ''; // Clear content

            switch (teacherDashboardState.view) {
                case 'roster':
                    renderRosterManagement(contentEl);
                    break;
                case 'goals':
                    renderGoalManagement(contentEl);
                    break;
                case 'tasks':
                    renderTaskAssignment(contentEl);
                    break;
                case 'messages':
                    renderMessageSending(contentEl);
                    break;
                case 'graduation':
                    renderGraduation(contentEl);
                    break;
                default:
                    contentEl.innerHTML = `<h2 class="pixel-font text-3xl text-guild-dark">è«‹å¾å·¦å´é¸å–®é¸æ“‡ç®¡ç†é …ç›®ã€‚</h2>`;
            }
        }

        // --- åå†Šç®¡ç† (18) ---
        function renderRosterManagement(el) {
            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ä¸€å€‹ä½”ä½ç¬¦ä¾†è¡¨ç¤ºæ‡‰ç”¨ç¨‹å¼çš„æ ¹ URLã€‚
            // éƒ¨ç½²å¾Œï¼Œè«‹å‹™å¿…å°‡æ­¤è®Šæ•¸æ›¿æ›ç‚ºæ‚¨å¯¦éš›çš„æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€‚
            // ä¾‹å¦‚: const APP_BASE_URL = "https://your-domain.com/";
            const APP_BASE_URL = window.location.protocol + "//" + window.location.host + window.location.pathname.split('?')[0];

            el.innerHTML = `
                <h2 class="pixel-font text-3xl text-guild-dark border-b-2 border-guild-wood pb-2 mb-4">å…¬æœƒåå†Š (å­¸ç”Ÿç®¡ç†)</h2>
                <div class="mb-6 p-4 bg-guild-parchment border-2 border-guild-wood rounded">
                    <h3 class="font-bold text-xl mb-2">æ–°å¢å­¸ç”Ÿ</h3>
                    <input type="text" id="new-student-name" placeholder="è¼¸å…¥å­¸ç”Ÿåç¨± (e.g. å°æ˜)" class="w-full p-2 border-2 border-gray-300 rounded mb-2">
                    <button class="guild-btn bg-green-600 hover:bg-green-700" onclick="addStudent()">åŠ å…¥åå†Š</button>
                    <p class="text-sm mt-2 text-red-600">åŠ å…¥å¾Œè«‹è¤‡è£½å°ˆå±¬é€£çµçµ¦å­¸ç”Ÿï¼Œä»¥å®Œæˆä¸€æ¬¡æ€§è¨»å†Šç¶å®šã€‚</p>
                </div>

                <h3 class="font-bold text-xl mb-2">ç¾æœ‰å†’éšªè€… (${studentList.length})</h3>
                <div class="space-y-2">
                    ${studentList.map(s => {
                        const isRegistered = s.isRegistered;
                        const enrollmentId = s.uid; // This is the UUID used for enrollment or actual UID
                        const statusText = isRegistered 
                            ? `âœ… å·²å•Ÿç”¨ (UID: ${s.uid.substring(0, 8)}...)` 
                            : `ğŸ”— æœªç¶å®š (è¨»å†Š ID: ${s.studentNo || enrollmentId.substring(0, 8)})`;
                        const linkButton = isRegistered 
                            ? `<span class="text-sm text-gray-500">å·²ç¶å®šèº«ä»½</span>`
                            : `<button class="guild-btn bg-blue-600 hover:bg-blue-700 text-sm py-1 px-2 ml-2" onclick="copyEnrollmentLink('${enrollmentId}', '${APP_BASE_URL}')">
                                ğŸ“‹ è¤‡è£½å°ˆå±¬é€£çµ
                              </button>`;
                        
                        return `
                            <div class="p-3 border rounded flex justify-between items-center ${isRegistered ? 'bg-blue-100' : 'bg-yellow-100'}">
                                <span>${s.name} ${statusText}</span>
                                <div class="flex items-center">
                                    ${linkButton}
                                    <button class="guild-btn bg-red-600 hover:bg-red-700 text-sm py-1 px-2 ml-2" onclick="deleteStudent('${s.uid}', '${s.name}')">åˆªé™¤</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <p class="mt-4 text-sm text-gray-600">å°ˆå±¬é€£çµæ ¼å¼ï¼š${APP_BASE_URL}?enrollId=[è¨»å†Š ID]</p>
            `;
        }

        async function addStudent() {
            const nameEl = document.getElementById('new-student-name');
            const name = nameEl.value.trim();
            if (!name) return showMessage("è«‹è¼¸å…¥å­¸ç”Ÿåç¨±ã€‚", true);
            if (studentList.some(s => s.name === name)) return showMessage("æ­¤åç¨±å·²å­˜åœ¨æ–¼åå†Šä¸­ã€‚", true);

            // ä½¿ç”¨ä¸€å€‹æ–°çš„éš¨æ©Ÿ ID ä½œç‚ºåˆå§‹ UID (é€™æ˜¯ç‚ºäº†ç”¢ç”Ÿä¸€å€‹é€£çµ/åç¨±çµ¦å­¸ç”Ÿèªé ˜)
            const uniqueId = crypto.randomUUID();
            const studentNo = (studentList.length + 1).toString().padStart(3, '0');

            try {
                // æ–°å¢ä¸€ç­†æœªè¨»å†Šçš„ç´€éŒ„
                // åˆå§‹çš„ uid (uniqueId) ç”¨ä¾†ä½œç‚ºè¨»å†Šé€£çµä¸­çš„ enrollmentId
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', uniqueId), {
                    uid: uniqueId, // æš«æ™‚çš„ ID (ä½œç‚ºè¨»å†Š ID)
                    teacherId: userId,
                    name: name,
                    studentNo: studentNo,
                    isRegistered: false, // å­¸ç”Ÿå°šæœªç¶å®š
                    totalXp: 0,
                    goals: [],
                });
                nameEl.value = '';
                showMessage(`å­¸ç”Ÿã€Œ${name}ã€å·²åŠ å…¥åå†Šã€‚`);
                // Listener will auto-update the list
            } catch (error) {
                console.error("åŠ å…¥åå†Šå¤±æ•—:", error);
                showMessage("åŠ å…¥åå†Šå¤±æ•—: " + error.message, true);
            }
        }

        async function deleteStudent(uid, name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${name}ã€çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) return;

            try {
                // 1. åˆªé™¤å­¸ç”Ÿå…¬é–‹è³‡æ–™ (profile/enrollment record)
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', uid));
                // 2. åˆªé™¤å­¸ç”Ÿç§äººè³‡æ–™ (logs, messages) - éœ€è¦çŸ¥é“è©²å­¸ç”Ÿçš„ final UID æ‰èƒ½åˆªé™¤ç§æœ‰è³‡æ–™ã€‚
                // ç”±æ–¼æ­¤è™•åˆªé™¤çš„æ˜¯ enrollment ID/Profile IDï¼Œå¦‚æœå®ƒå·²ç¶“è¨»å†Šï¼Œå‰‡çœŸæ­£çš„ UID æ˜¯ studentProfile.uidï¼Œé€™åœ¨ç•¶å‰ç°¡å–®æ¶æ§‹ä¸­è¼ƒé›£ç›´æ¥ç²å–ï¼Œæ•…æ­¤è™•åƒ…åˆªé™¤å…¬é–‹åå†Šç´€éŒ„ã€‚

                showMessage(`å­¸ç”Ÿã€Œ${name}ã€å·²å¾åå†Šä¸­ç§»é™¤ã€‚`);
            } catch (error) {
                console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", error);
                showMessage("åˆªé™¤å¤±æ•—: " + error.message, true);
            }
        }

        // --- ç•¢æ¥­åŠŸèƒ½ (13) ---
        function renderGraduation(el) {
            el.innerHTML = `
                <h2 class="pixel-font text-3xl text-red-700 border-b-2 border-guild-wood pb-2 mb-4">ğŸ“ ç•¢æ¥­ (æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™)</h2>
                <div class="p-6 bg-red-100 border-4 border-red-500 rounded text-center">
                    <p class="text-xl font-bold text-red-800 mb-4">ğŸš¨ è­¦å‘Šï¼šæ­¤æ“ä½œå°‡æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿçš„è³‡æ–™ (XP, Level, Goals, Logs, Messages, Profiles)ã€‚</p>
                    <p class="mb-6">è«‹ç¢ºèªæ‰€æœ‰å­¸ç”Ÿéƒ½å·²ã€Œç•¢æ¥­ã€ï¼Œæº–å‚™è¿æ¥ä¸‹ä¸€å±†æ–°ç”Ÿã€‚</p>
                    <button class="guild-btn bg-red-700 hover:bg-red-800 text-white text-lg" onclick="handleGraduation()">
                        ğŸ’£ ç¢ºèªæ¸…é™¤æ‰€æœ‰å­¸ç”Ÿè³‡æ–™
                    </button>
                    <p class="mt-4 text-sm text-gray-600">æ•™å¸«å¸³è™Ÿå’Œç­ç´šè¨­å®šå°‡ä¿ç•™ã€‚</p>
                </div>
            `;
        }

        async function handleGraduation() {
            if (!confirm("ğŸš¨ æœ€å¾Œç¢ºèªï¼šæ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç”Ÿçš„è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;

            try {
                const studentsCol = collection(db, 'artifacts', appId, 'public', 'data', 'students');
                const studentsSnapshot = await getDocs(query(studentsCol, where("teacherId", "==", userId)));

                const deletePromises = [];

                studentsSnapshot.forEach(docSnap => {
                    // åˆªé™¤å…¬é–‹è³‡æ–™ (Profile/Enrollment record)
                    deletePromises.push(deleteDoc(docSnap.ref));

                    // åˆªé™¤ç§äººè³‡æ–™ (Logs, Messages) - å‡è¨­æˆ‘å€‘éœ€è¦çŸ¥é“æœ€çµ‚çš„ UID æ‰èƒ½åˆªé™¤ï¼Œé€™è£¡åƒ…åˆªé™¤å…¬é–‹ç´€éŒ„ã€‚
                });

                await Promise.all(deletePromises);
                showMessage("âœ… ç•¢æ¥­æˆåŠŸï¼æ‰€æœ‰å­¸ç”Ÿè³‡æ–™å·²æ¸…é™¤ï¼Œå…¬æœƒå·²æº–å‚™å¥½è¿æ¥ä¸‹ä¸€å±†æ–°ç”Ÿã€‚", false);
            } catch (error) {
                console.error("ç•¢æ¥­æµç¨‹å¤±æ•—:", error);
                showMessage("ç•¢æ¥­æµç¨‹å¤±æ•—: " + error.message, true);
            }
        }

        // --- Enrollment Link Copy Function ---
        function copyEnrollmentLink(enrollmentId, appUrl) {
            // appUrl æ˜¯ç”± renderRosterManagement å‚³å…¥çš„åŸºç¤ URLï¼Œç”¨æ–¼ç¢ºä¿é€£çµæ ¼å¼æ­£ç¢º
            const enrollmentLink = `${appUrl}?enrollId=${enrollmentId}`;
            
            const tempInput = document.createElement('input');
            tempInput.value = enrollmentLink;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                showMessage(`âœ… å°ˆå±¬é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿: ${enrollmentLink}`);
            } catch (err) {
                console.error('ç„¡æ³•è¤‡è£½é€£çµ', err);
                showMessage(`âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ­¤é€£çµï¼š${enrollmentLink}`, true);
            }
            document.body.removeChild(tempInput);
        }

        // --- å…¶ä»–æ•™å¸«åŠŸèƒ½ (Goals, Tasks, Messages) - åƒ…æä¾›ä»‹é¢æ¡†æ¶å’Œæ ¸å¿ƒé‚è¼¯ ---

        // ç›®æ¨™ç®¡ç† (4)
        function renderGoalManagement(el) {
            el.innerHTML = `
                <h2 class="pixel-font text-3xl text-guild-dark border-b-2 border-guild-wood pb-2 mb-4">ç¿’æ…£ç›®æ¨™æ± ç®¡ç†</h2>
                <p class="mb-4">ç‚ºå­¸ç”Ÿè¨­å®šã€Œå¥½ç¿’æ…£ç›®æ¨™æ± ã€ã€‚æ¯æ—¥ä»»å‹™æœƒå¾é€™äº›ç›®æ¨™ä¸­éš¨æ©Ÿé¸å–ã€‚</p>
                
                <label for="goal-student-select" class="block font-bold mb-2">é¸æ“‡å­¸ç”Ÿ:</label>
                <select id="goal-student-select" class="p-2 border rounded w-full mb-4" onchange="teacherDashboardState.selectedStudentId = this.value; renderGoalList(this.value)">
                    <option value="">-- è«‹é¸æ“‡ä¸€ä½å­¸ç”Ÿ --</option>
                    ${studentList.filter(s => s.isRegistered).map(s => `<option value="${s.uid}" ${teacherDashboardState.selectedStudentId === s.uid ? 'selected' : ''}>${s.name}</option>`).join('')}
                </select>

                <div id="student-goals-container" class="guild-card bg-guild-parchment/70 min-h-[200px] p-4">
                    <p class="text-center text-gray-500">è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿã€‚</p>
                </div>
            `;
            if (teacherDashboardState.selectedStudentId) renderGoalList(teacherDashboardState.selectedStudentId);
        }

        // ç™»å‡º
        async function handleLogout() {
            try {
                await signOut(auth);
                // Auth listener will handle the view change to login
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showMessage("ç™»å‡ºå¤±æ•—: " + error.message, true);
            }
        }

        // --- å°‡æ‰€æœ‰éœ€è¦å¾ HTML å…§è¯äº‹ä»¶èª¿ç”¨çš„å‡½æ•¸æš´éœ²åˆ° window ç‰©ä»¶ ---
        
        // ä½”ä½å‡½æ•¸ï¼šé¿å…åœ¨é»æ“Šç›®æ¨™ç®¡ç†æ™‚å ±éŒ¯
        window.renderGoalList = (uid) => {
            const el = document.getElementById('student-goals-container');
            if (el) el.innerHTML = `<p class="text-center text-guild-dark">ç›®æ¨™æ± ç®¡ç†åŠŸèƒ½ï¼ˆå¾…å¯¦ä½œï¼‰ã€‚ç›®å‰é¸æ“‡çš„å­¸ç”Ÿ UID: ${uid}</p>`;
        };

        // æš´éœ²ä¸»è¦åŠŸèƒ½å‡½æ•¸
        window.handleLogout = handleLogout;
        window.addStudent = addStudent;
        window.deleteStudent = deleteStudent;
        window.handleGraduation = handleGraduation;
        window.toggleTaskCompletion = toggleTaskCompletion;
        window.fetchAndRenderDailyTasks = fetchAndRenderDailyTasks;
        window.copyEnrollmentLink = copyEnrollmentLink;
        window.claimStudentProfile = claimStudentProfile;


    </script>
</head>
<body>
    <div id="status-message" style="display: none;" class="fixed top-4 right-4 z-50 p-3 rounded-md shadow-lg"></div>
    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-8">
        <!-- å…§å®¹æœƒåœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
        <div class="text-center p-8 guild-card">
            <h2 class="pixel-font text-3xl text-guild-dark">å…¬æœƒæº–å‚™ä¸­...</h2>
            <p class="mt-4">æ­£åœ¨é©—è­‰æ‚¨çš„å†’éšªè€…èº«ä»½...</p>
        </div>
    </div>
</body>
</html>